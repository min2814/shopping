<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>나이키 스타일 상품 상세 페이지</title>
    <link rel="stylesheet" href="../css/detail.css">
    <script src="https://kit.fontawesome.com/5c3afda2cc.js" crossorigin="anonymous"></script>
</head>

<body>
    <header class="top-bar">
        <div class="top-left">
            <div class="delivery-toggle" role="tablist" aria-label="배송 방식">
                <button class="nav-btn active" role="tab" aria-selected="true">Delivery</button>
                <button class="nav-btn" role="tab" aria-selected="false">Pickup</button>
            </div>
            <span class="address">Select the delivery address</span>
            <span class="edit-icon" aria-hidden="true"><i class="fa-regular fa-pen-to-square"></i></span>
            <!-- ↓ 장바구니 페이지와 동일: 날짜는 JS가 #delivery-time-text에 채움 -->
            <span class="delivery-time">Nearest delivery <strong id="delivery-time-text"></strong></span>
        </div>
        <div class="top-right">
            <span class="phone"><strong>+ 8 800 555-35-35 </strong>Around the clock</span>
        </div>
    </header>

    <div class="search-section">
        <button class="catalog-btn" type="button">
            <i class="fa-regular fa-clone" aria-hidden="true"></i>
            Catalog
        </button>

        <div class="search-group">
            <div class="search-pill">
                <select class="category-select" aria-label="카테고리">
                    <option>ALL CATEGORIES</option>
                </select>
                <input class="search-input" type="text" placeholder="Search in the market" aria-label="검색어 입력">
            </div>
            <button class="search-submit" type="button" aria-label="검색">
                <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
            </button>
        </div>

        <!-- ↓ icons: 구조를 장바구니 페이지와 동일하게 (특히 .cart-icon 내부 미니카트 포함) -->
        <div class="icons" aria-label="바로가기 아이콘">
            <a href="./main.html">
                <div class="icon-box" role="button" tabindex="0" aria-label="배송">
                    <i class="fa-solid fa-house" aria-hidden="true"></i>
                </div>
            </a>

            <div class="icon-box" role="button" tabindex="0" aria-label="찜">
                <i class="fa-solid fa-heart" aria-hidden="true"></i>
            </div>

            <div class="icon-box cart-icon" role="button" tabindex="0" aria-label="장바구니">
                <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
                <span class="cart-badge" id="cart-count">0</span>
                <!-- mini cart panel -->
                <div class="mini-cart" id="mini-cart" aria-hidden="true">
                    <div class="mini-cart__header">
                        <strong>Checkout Goods</strong>
                        <button class="mini-cart__close" aria-label="닫기">&times;</button>
                    </div>
                    <ul class="mini-cart__list" id="mini-cart-list"></ul>
                    <div class="mini-cart__summary">
                        <div class="row"><span>Order Amount</span><span id="mini-order">$0.00</span></div>
                        <div class="row"><span>Delivery</span><span id="mini-delivery">$0.00</span></div>
                        <div class="row total"><span>Total</span><span id="mini-total">$0.00</span></div>
                    </div>
                    <div class="mini-cart__actions">
                        <button type="button" class="mini-btn ghost" id="mini-view-cart">
                            <a href="./shopping_cart.html" class="view_cart">View cart</a></button>
                        <button type="button" class="mini-btn primary" id="mini-checkout">Checkout now</button>
                    </div>
                </div>
            </div>

            <a href="./mypage.html">
                <div class="icon-box" role="button" tabindex="0" aria-label="마이페이지">
                    <i class="fa-solid fa-user" aria-hidden="true"></i>
                </div>
            </a>
        </div>
    </div>


    <div class="container" id="product-container">
        <div class="image-section">
            <p id="loading-text">이미지 로딩 중...</p>
            <img id="product-image" src="" alt="상품 이미지" style="display: none;" />
        </div>
        <div class="info-section">
            <h1 class="product-title" id="product-title"></h1>
            <div class="product-price" id="product-price"></div>
            <div class="product-description" id="product-description"></div>

            <div class="options">
                <div class="option-group">
                    <label>색상</label>
                    <div class="option-buttons" id="color-options"></div>
                </div>
                <div class="option-group">
                    <label>사이즈</label>
                    <div class="option-buttons" id="size-options"></div>
                </div>
            </div>

            <button class="btn-add-cart" id="add-cart-btn">장바구니에 담기</button>
        </div>
    </div>

    <script>
        // 목록 페이지에서 저장한 상품 정보 불러오기
        const product = JSON.parse(localStorage.getItem("selectedProduct"));

        const colors = ['검정', '흰색', '빨강', '파랑'];
        const sizes = ['S', 'M', 'L', 'XL'];

        let selectedColor = null;
        let selectedSize = null;

        const imgElement = document.getElementById('product-image');
        const loadingText = document.getElementById('loading-text');

        if (!product) {
            alert("상품 정보가 없습니다. 메인 페이지로 이동합니다.");
            window.location.href = "list.html"; // 상품 목록 페이지로 이동
        } else {
            // 이미지 표시
            setProductImage(product.image, product.name);

            // 상품 정보 표시
            document.getElementById('product-title').textContent = product.name;
            document.getElementById('product-price').textContent = '$' + product.price;
            document.getElementById('product-description').textContent = product.description || '';

            // 옵션 버튼 생성
            createOptionButtons('color-options', colors, (color) => {
                selectedColor = color;
                updateSelected('color-options', color);
            });

            createOptionButtons('size-options', sizes, (size) => {
                selectedSize = size;
                updateSelected('size-options', size);
            });
        }

        function createOptionButtons(containerId, options, onClick) {
            const container = document.getElementById(containerId);
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.textContent = option;
                btn.addEventListener('click', () => {
                    const isSelected = btn.classList.contains('selected');
                    if (isSelected) {
                        btn.classList.remove('selected');
                        if (containerId === 'color-options') selectedColor = null;
                        if (containerId === 'size-options') selectedSize = null;
                    } else {
                        onClick(option);
                    }
                });
                container.appendChild(btn);
            });
        }

        function updateSelected(containerId, selectedValue) {
            const container = document.getElementById(containerId);
            [...container.children].forEach(btn => {
                btn.classList.toggle('selected', btn.textContent === selectedValue);
            });
        }

        function setProductImage(url, alt) {
            loadingText.style.display = 'block';
            imgElement.style.display = 'none';
            imgElement.alt = alt;

            imgElement.onload = () => {
                loadingText.style.display = 'none';
                imgElement.style.display = 'block';
            };

            imgElement.onerror = () => {
                loadingText.textContent = '이미지를 불러오지 못했습니다.';
            };

            imgElement.src = url;
        }

        document.getElementById('add-cart-btn').addEventListener('click', () => {
            if (!selectedColor || !selectedSize) {
                alert('색상과 사이즈를 선택해주세요.');
                return;
            }
            //cart라는 이름으로 저장돤 JSON 문자열을 가지고 와서 JS객체로 전환
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart.push({
                id: product.id,
                title: product.name,
                image: product.image,
                category: product.category,
                price: product.price,
                color: selectedColor,
                size: selectedSize,
                quantity: 1
            });
            //cart라는 이름으로 객체를 JSON 문자열로 저장
            localStorage.setItem('cart', JSON.stringify(cart));
            alert('장바구니에 담았습니다!');
            if (confirm('메인 페이지로 이동하겠습니까?')) {
                if (confirm('정말로?')) {
                    location.href = 'http://127.0.0.1:5500/shopping_cart.html';
                }
            }
        });
        // header m ,,
        const DELIVERY_FEE = 5;

        function loadCartFromStorage() {
            return JSON.parse(localStorage.getItem("cart")) || [];
        }

        function groupCartItems(raw) {
            const map = {};
            for (const it of raw) {
                const key = (it.id !== null && it.id !== undefined) ? it.id : it.title;

                if (!map[key]) map[key] = {
                    ...it,
                    quantity: 0,
                    _key: key
                };
                map[key].quantity += 1;
            }
            return Object.values(map);
        }

        // ---- 배지/미니카트 ----
        const cartIcon = document.querySelector(".cart-icon");
        const miniCart = document.getElementById("mini-cart");
        const miniList = document.getElementById("mini-cart-list");
        const miniOrder = document.getElementById("mini-order");
        const miniDelivery = document.getElementById("mini-delivery");
        const miniTotal = document.getElementById("mini-total");
        const miniCheckoutBtn = document.getElementById("mini-checkout");
        const miniViewCartBtn = document.getElementById("mini-view-cart");
        const miniCloseBtn = document.querySelector(".mini-cart__close");
        const cartCountBadge = document.getElementById("cart-count");

        function updateCartBadge() {
            const cnt = loadCartFromStorage().length;
            if (cartCountBadge) {
                cartCountBadge.textContent = cnt;
                cartCountBadge.style.display = cnt > 0 ? "inline-block" : "none";
            }
        }

        function renderMiniCart() {
            if (!miniList) return;
            const grouped = groupCartItems(loadCartFromStorage());
            miniList.innerHTML = "";
            grouped.forEach(item => {
                const li = document.createElement("li");
                li.className = "mini-cart__item";
                li.innerHTML = `
        <img class="mini-cart__thumb" src="${item.image}" alt="${item.title}">
        <div class="mini-cart__meta">
            <div class="mini-cart__title">${item.title}</div>
            <div class="mini-cart__sub">x${item.quantity} · ${item.category || ""}</div>
        </div>
        <div class="mini-cart__price">$${(item.price*item.quantity).toFixed(2)}</div>
        `;
                miniList.appendChild(li);
            });
            const order = grouped.reduce((s, i) => s + i.price * i.quantity, 0);
            const delv = grouped.length === 0 ? 0 : DELIVERY_FEE;
            const total = order + delv;
            if (miniOrder) miniOrder.textContent = `$${order.toFixed(2)}`;
            if (miniDelivery) miniDelivery.textContent = `$${delv.toFixed(2)}`;
            if (miniTotal) miniTotal.textContent = `$${total.toFixed(2)}`;
            if (miniCheckoutBtn) miniCheckoutBtn.disabled = grouped.length === 0;
        }

        function proceedCheckout() {
            const grouped = groupCartItems(loadCartFromStorage());
            if (!grouped.length) return;
            const productsForPayment = grouped.map(({
                _key,
                ...rest
            }) => rest);
            localStorage.setItem("products", JSON.stringify(productsForPayment));
            const order = grouped.reduce((s, i) => s + i.price * i.quantity, 0);
            const delv = grouped.length === 0 ? 0 : DELIVERY_FEE;
            const total = order + delv;
            localStorage.setItem("summary", JSON.stringify({
                order: Number(order.toFixed(2)),
                delivery: Number(delv.toFixed(2)),
                total: Number(total.toFixed(2))
            }));
            window.location.href = "./pay.html";
        }

        // 이벤트: 아이콘/닫기/ESC/바깥클릭
        if (cartIcon) {
            cartIcon.addEventListener("click", (e) => {
                e.stopPropagation();
                cartIcon.classList.toggle("open");
                renderMiniCart();
            });
            document.addEventListener("click", (e) => {
                if (!cartIcon.contains(e.target)) cartIcon.classList.remove("open");
            });
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") cartIcon.classList.remove("open");
            });
        }
        if (miniCloseBtn) miniCloseBtn.addEventListener("click", () => cartIcon.classList.remove("open"));
        if (miniCheckoutBtn) miniCheckoutBtn.addEventListener("click", proceedCheckout);
        if (miniViewCartBtn) miniViewCartBtn.addEventListener("click", () => {
            if (location.pathname.endsWith("shopping_cart.html") || location.pathname.endsWith("cart.html")) {
                cartIcon.classList.remove("open");
            } else {
                location.href = "./shopping_cart.html";
            }
        });

        // ---- 검색 이동만 (자동완성은 원하면 장바구니 코드 재사용 가능) ----
        const searchInput = document.querySelector(".search-input");
        const searchButton = document.querySelector(".search-submit");

        function goSearch(q) {
            const s = (
                q !== null && q !== undefined ?
                q :
                (searchInput && searchInput.value) || ""
            ).trim();

            if (s) window.location.href = `list.html?query=${encodeURIComponent(s)}`;
        }
        if (searchButton) searchButton.addEventListener("click", () => goSearch());
        if (searchInput) searchInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                goSearch();
            }
        });

        // ---- 배송 날짜 텍스트 (#delivery-time-text) ----
        (function updateDeliveryDate() {
            const el = document.getElementById("delivery-time-text");
            if (!el) return;
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, "0");
            const d = String(now.getDate()).padStart(2, "0");
            el.textContent = `: ${y}-${m}-${d}`;
        })();

        // 초기 동기화
        updateCartBadge();
        renderMiniCart();
    </script>
</body>

</html>