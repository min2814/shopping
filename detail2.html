<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>나이키 스타일 상품 상세 페이지</title>
    <link rel="stylesheet" href="detail.css">
    <script src="https://kit.fontawesome.com/5c3afda2cc.js" crossorigin="anonymous"></script>
</head>

<body>
    <header class="top-bar">
        <div class="top-left">
            <div class="delivery-toggle" role="tablist" aria-label="배송 방식">
                <button class="nav-btn active" role="tab" aria-selected="true">Delivery</button>
                <button class="nav-btn" role="tab" aria-selected="false">Pickup</button>
            </div>
            <span class="address">Select the delivery address</span>
            <span class="edit-icon" aria-hidden="true"><i class="fa-regular fa-pen-to-square"></i></span>
            <span class="delivery-time">Nearest delivery <strong>today is 13:00-14:00</strong></span>
        </div>
        <div class="top-right">
            <span class="phone"><strong>+ 8 800 555-35-35 </strong>Around the clock</span>
        </div>
    </header>

    <div class="search-section">
        <button class="catalog-btn" type="button">
            <i class="fa-regular fa-clone" aria-hidden="true"></i>
            Catalog
        </button>

        <div class="search-group">
            <div class="search-pill">
                <select class="category-select" aria-label="카테고리">
                    <option>ALL CATEGORIES</option>
                </select>
                <input class="search-input" type="text" placeholder="Search in the market" aria-label="검색어 입력">
            </div>

            <button class="search-submit" type="button" aria-label="검색">
                <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
            </button>
        </div>

        <div class="icons" aria-label="바로가기 아이콘">
            <div class="icon-box" role="button" tabindex="0" aria-label="배송">
                <i class="fa-solid fa-truck" aria-hidden="true"></i>
            </div>
            <div class="icon-box" role="button" tabindex="0" aria-label="찜">
                <i class="fa-solid fa-heart" aria-hidden="true"></i>
            </div>
            <div class="icon-box" role="button" tabindex="0" aria-label="장바구니">
                <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
            </div>
            <div class="icon-box" role="button" tabindex="0" aria-label="마이페이지">
                <i class="fa-solid fa-user" aria-hidden="true"></i>
            </div>
        </div>
    </div>

    <div class="container" id="product-container">
        <div class="image-section">
            <div class="media-box">
                <p id="loading-text">이미지 로딩 중...</p>
                <img id="product-image" src="" alt="상품 이미지" style="display: none;" />
            </div>
        </div>
        <div class="info-section">
            <h1 class="product-title" id="product-title"></h1>
            <div class="product-price" id="product-price"></div>
            <div class="product-description" id="product-description"></div>

            <div class="options">
                <div class="option-group" id="color-group">
                    <label>색상</label>
                    <div class="option-buttons" id="color-options"></div>
                </div>
                <div class="option-group" id="size-group">
                    <label>사이즈</label>
                    <div class="option-buttons" id="size-options"></div>
                </div>
            </div>

            <button class="btn-add-cart" id="add-cart-btn">장바구니에 담기</button>
            <!-- 모달 -->
            <dialog id="cartDialog">
                <p>장바구니에 담았습니다.<br>계속 쇼핑하겠습니까?</p>
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <button id="yesBtn">예</button>
                    <button id="noBtn">아니오</button>
                </div>
            </dialog>
        </div>
    </div>

    <script>
        // 목록 페이지에서 저장한 상품 정보 불러오기
        const product = JSON.parse(localStorage.getItem("selectedProduct"));

        const cartDialog = document.getElementById('cartDialog');
        const colorGroup = document.getElementById('color-group') || document.querySelector('.options .option-group:nth-child(1)');
        const sizeGroup = document.getElementById('size-group') || document.querySelector('.options .option-group:nth-child(2)');

        const OPTION_RULES = {
            "men's clothing": { colors: ['black', 'white', 'navy', 'beige'], sizes: ['S', 'M', 'L', 'XL'] },
            "women's clothing": { colors: ['black', 'white', 'purple', 'red', 'navy'], sizes: ['S', 'M', 'L'] },
            "electronics": { colors: ['black', 'silver'], sizes: [] },
            "jewelery": { colors: [], sizes: [] },
        };

        // 카테고리별 라벨/안내 문구
        const LABEL_TEXT = {
            default: { color: '색상', size: '사이즈' },
            jewelery: { color: '색상(단일)', size: 'FREE SIZE' },
            electronics: { color: '색상', size: '사이즈 옵션 없음' },
        };

        const slug = (s = '') => s.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        const labelFor = (category) => {
            const s = slug(category);
            if (s.includes('jewel')) return LABEL_TEXT.jewelery;
            if (s.includes('electronic')) return LABEL_TEXT.electronics;
            return LABEL_TEXT.default;
        };

        // 카테고리명을 CSS에서 쓰기 좋게 slug로 만들어 body에 클래스 부여
        const toSlug = (s = '') => s.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        const catClass = 'cat-' + toSlug(product.category || '');
        document.body.classList.add(catClass);

        // 버튼 영역 숨기고 안내문 넣는 함수
        function showNote(groupId, noteText) {
            const group = document.getElementById(groupId);
            if (!group) return;
            const btns = group.querySelector('.option-buttons');
            if (btns) btns.style.display = 'none';

            // note가 없으면 생성
            let note = group.querySelector('.option-note');
            if (!note) {
                note = document.createElement('div');
                note.className = 'option-note';
                group.appendChild(note);
            }
            note.textContent = noteText;
            group.style.display = ''; // 보이도록
        }

        const getRule = (cat) => OPTION_RULES[cat] || { colors: [], sizes: [] };

        let selectedColor = null;
        let selectedSize = null;

        const imgElement = document.getElementById('product-image');
        const loadingText = document.getElementById('loading-text');

        if (!product) {
            alert("상품 정보가 없습니다. 메인 페이지로 이동합니다.");
            window.location.href = "index.html"; // 상품 목록 페이지로 이동
        } else {
            // 이미지 표시
            setProductImage(product.image, product.name);

            // 상품 정보 표시
            document.getElementById('product-title').textContent = product.name;
            document.getElementById('product-price').textContent = '$' + product.price;
            document.getElementById('product-description').textContent = product.description || '';

            //카테고리 별 color, size 배열들 관리(rule은 카테고리 별 color size 여부)
            const rule = getRule(product.category);

            //카테고리별 라벨 및 텍스트
            const labelText = labelFor(product.category);

            const colorLabel = document.querySelector('#color-group label');
            const sizeLabel = document.querySelector('#size-group label');

            if (colorLabel) {
                colorLabel.textContent = labelText.color;
            }
            if (sizeLabel) {
                sizeLabel.textContent = labelText.size;
            }
            // 색상 - 카테고리별 colors의 길이가 있으면 버튼을(rule.colors) 생성
            if (rule.colors.length) {
                createOptionButtons('color-options', rule.colors, (color) => {
                    selectedColor = color;
                    updateSelected('color-options', color);
                });
                document.getElementById('color-group').style.display = '';
            } else {
                // 버튼은 숨기고, 라벨은 카테고리 맞춤 문구로 유지 + 안내노트 추가(선택)
                showNote('color-group', '선택 가능한 색상 옵션이 없습니다.');
            }

            // 사이즈 - 카테고리별 sizes의 길이가 있으면 버튼을(rule.sizes) 생성
            if (rule.sizes.length) {
                createOptionButtons('size-options', rule.sizes, (size) => {
                    selectedSize = size;
                    updateSelected('size-options', size);
                });
                document.getElementById('size-group').style.display = '';
            } else {
                showNote('size-group', '사이즈 선택 없이 구매 가능합니다.');
            }
        }

        function createOptionButtons(containerId, options, onClick) {
            const container = document.getElementById(containerId);
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.textContent = option;
                btn.addEventListener('click', () => {
                    const isSelected = btn.classList.contains('selected');
                    if (isSelected) {
                        btn.classList.remove('selected');
                        if (containerId === 'color-options') selectedColor = null;
                        if (containerId === 'size-options') selectedSize = null;
                    } else {
                        onClick(option);
                    }
                });
                container.appendChild(btn);
            });
        }

        function updateSelected(containerId, selectedValue) {
            const container = document.getElementById(containerId);
            [...container.children].forEach(btn => {
                btn.classList.toggle('selected', btn.textContent === selectedValue);
            });
        }

        function setProductImage(url, alt) {
            loadingText.style.display = 'block';
            imgElement.style.display = 'none';
            imgElement.alt = alt;

            imgElement.onload = () => {
                loadingText.style.display = 'none';
                imgElement.style.display = 'block';
            };

            imgElement.onerror = () => {
                loadingText.textContent = '이미지를 불러오지 못했습니다.';
            };

            imgElement.src = url;
        }

        document.getElementById('add-cart-btn').addEventListener('click', () => {
            const rule = getRule(product.category);
            const needColor = rule.colors.length > 0;
            const needSize = rule.sizes.length > 0;

            if ((needColor && !selectedColor) || (needSize && !selectedSize)) {
                alert('필요한 옵션을 선택해주세요.');
                return;
            }
            //cart라는 이름으로 저장돤 JSON 문자열을 가지고 와서 JS객체로 전환
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart.push({
                id: product.id,
                title: product.name,
                image: product.image,
                category: product.category,
                price: product.price,
                color: needColor ? selectedColor : null,
                size: needSize ? selectedSize : null,
            });
            //cart라는 이름으로 객체를 JSON 문자열로 저장
            localStorage.setItem('cart', JSON.stringify(cart));

            cartDialog.showModal();
        });

        document.getElementById('yesBtn').addEventListener('click', () => {
            cartDialog.close();
        })

        document.getElementById('noBtn').addEventListener('click', () => {
            cartDialog.close();
            if (confirm('장바구니로 이동하겠습니까?')) {
                location.href = "http://127.0.0.1:5500/shopping_cart.html"
            }

        })
    </script>
</body>

</html>